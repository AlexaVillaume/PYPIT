.. highlight:: rest

*****
Setup
*****

This document will describe how to organize your
raw files and the settings files for running PYPIT.

If you tend to observe with one instrument configuration
and with a simple set of calibrations, then setup should
be straightforward.  If you use multiple configurations
(e.g. gratings, grating tilts), then one must pay more
careful attention to the setup.

Raw Files
=========

The raw files may be located anywhere on the harddrive.
We recommend you organize them by date of observation.
They can be gzipped although Python's FITS reader works
considerably slower on compressed files.

pypit_setup
===========

PYPIT includes a script that one may execute (*recommended*)
to initiate the data reduction process.  This script helps organize
the primary data reduction process that follows.  It also
generates a default Settings File which can be edited further
to run PYPIT.

Execution
---------

The setup script requires two inputs: the root of the data
files (with the full path) and the instrument name.  Here is an example::

    pypit_setup /Users/xavier/Keck/LRIS/data/2016apr06/Raw/LB lris_blue

The code will search for all FITS files with the inputted root.
Note that the root should **not** contain a wild-card.

Alternatively, one can generate a Settings File (with extension .pypit)
and add `run setup True` to the file.

Note that both of these options sets default values in the codes
and over-rides other user settings.

Outputs
-------

The pypit_setup script generates several outputs.

Setup File
++++++++++

The most important file generated
is a .setup file, e.g. lris_blue_2016-Nov-18.setup.  This file describes
all of the instrument configurations that were parsed by the
code for the input raw files.  It is a YAML file and each
top-level key indicates the setup values, e.g. '01'.
Note that PYPIT generates a unique setup for every detector in the
instrument.

The remainder of the information in the .setup file describes
the instrument configuration.

**Important:**  There can be only one .setup file in a working
PYPIT reduction folder for each instrument being reduced.

Here is sample output for the LRISb instrument::

    '01':
      detector: {binning: '2,2', det: 1, naxis0: None, naxis1: None}
      dichroic: '560'
      disperser: {angle: None, name: 600/4000}
      slit: {decker: long_1.0, slitlen: None, slitwid: None}


Data Listings
+++++++++++++

Two files are generated which describe the input raw files,
line by line.  These have .lst and .xml extensions.
Data pulled from the header are shown here.  In addition, the
frametype assigned by PYPIT is specified.  If any of these are
mis-specified (possible), they should be correctly specified
in your Settings File.

Groupings
+++++++++

A .group file is generated which describes how PYPIT will
group calibrations, science, and standard star frames when
performing the reduction.  If there are incorrect or if unwanted
calibration files are listed, these should be suppressed with
the Settings File (alternatively one can remove them from the raw data
folder, but we *recommend* again this practice).

Setups that only differ by detector are grouped together in
the .group file. For example, '01_02' is a single instrument configuration
with two detectors.  The next configuration would have '03_04', etc.

Here is example output of a .group file for Kast (which has
only 1 detector per spectrograph)::

    '01':
      arc: [b1.fits.gz]
      bias: [b23.fits.gz, b22.fits.gz, b21.fits.gz]
      pixelflat: [b13.fits.gz, b12.fits.gz, b11.fits.gz]
      science: [b27.fits.gz, b28.fits.gz, b29.fits.gz]
      sciobj: [J1217p3905, J1217p3905, J1217p3905]
      slitflat: [b13.fits.gz, b12.fits.gz, b11.fits.gz]
      standard: [b24.fits.gz]
      stdobj: [Feige 66]
      trace: []

Note: when generated by the pypit_setup script, the .group file
will list only the first arc frame found.

Settings File
=============
To begin reducing your data, you'll need a settings file
with the extension ".pypit" that will provide the information
necessary for PYPIT to know how to proceed with reducing your
particular set of data.

We *recommend* that you generate a unique Settings File for each
instrument setup (modulo detectors) or for each target.
It is possible that you will need to modify the settings for
different gratings, etc.  It will also enable you to more
easily customize the associated calibration files.

This section will instruct you on how to build a .pypit
setting file from scratch. For reference, there are
existing settings files in PYPIT development suite.
The PYPIT development suite is recommended for download in
:doc:`installing`, and the relevant settings files are located
in::

    ~/PYPIT-development-suite/pypit_files/

However, let's look at how to make one from scratch.

Settings File, line by line
+++++++++++++++++++++++++++
Create a .pypit file. Name it anything you want, but for example,
it's useful to have: the instrument name, the grating or grism used,
the dichroic, etc. For example, we could call our settings file
'lris_blue_long_600_4000_d560.pypit', for our data as collected
on LRIS's blue arm, in long slit mode, using the 600/4000 grism
and d560 dichroic.

You can make any comments in your .pypit settings file with a
pound sign::

    # This is a comment line

The first thing you'll need to include is any changes on the
default settings. Most of these, except the spectrograph, aren't
truly necessary in the most basic settings file (there are existing
set defaults), but will be useful for running PYPIT::

    # Change the default settings
    run ncpus 1                     # number of CPUs to use; can also negative integers,
                                    so -1 means all but one CPU
    run spectrograph lris_blue      # the spectrograph (+arm, if necessary) this set of data is from;
                                    see README for list of available instruments
    output verbosity 2                   # level of screen output; 0 = no output, 1 = low level of output;
                                    2 = output everything
    output overwrite True              # overwrite any existing output files?
    output sorted lris_blue_long_600_4000_d560     # name of output files

Next, tell PYPIT where your raw data lives!::

    # Read in the data
    data read
     /Users/path/to/your/raw/data/*.fits
    data end

Then, give PYPIT some information about your raw data. For
example, PYPIT only accepts calibration files if they were
created within a time window of the science frame of interest.
You can set your own time window here. PYPIT also requires a
certain number of each type of calibration file to be matched
with the science frame, and here you can set what you want the
minimum to be::

    spect read
     #fits calwin 1000.     # calibration window; default window is 12 hrs;
                            here it is changed to 1000. hrs
     pixelflat number 1       # number of pixel flats needed for data reduction
     bias number 3          # number of bias frames; note that in this case,
                            PYPIT will combine the 3 biases into a master bias
     arc number 1           # number of arcs
     trace number 1         # number of trace frames
    spect end

Settings File, as a whole
+++++++++++++++++++++++++
With that, the most basic settings file looks something like this::

    # Change the default settings
    run ncpus 1
    run spectrograph lris_blue
    output verbosity 2
    output overwrite True
    output sorted lris_blue_long_600_4000_d560

    # Read in the data
    data read
     /Users/path/to/your/raw/data/*.fits
    data end

    spect read
     #fits calwin 1000.

     pixelflat number 1
     bias number 3
     arc number 1
     trace number 1
    spect end

You can now run PYPIT with this .pypit settings file! See how in
:doc:`running`.

Additional parameters for the Settings File
+++++++++++++++++++++++++++++++++++++++++++
In addition to the basic settings file as shown above, there
are other parameters that you can tell PYPIT to run by::

    # Reduce


    spect read
     # not needed if everything runs smoothly. Check your .lst file and make sure that each frame was identified correctly (that each file is properly identified as a bias, arc, slitflat, standard, science). If any file was misidentified, you can force the file type to be something different below (note that you can also identify your various calibration and science files below if you don't want to deal with the .lst file):

     #set bias     b150910_2036.fits.gz
     #set bias     b150910_2037.fits.gz
     #set bias     b150910_2038.fits.gz
     #set pixelflat  b150910_2051.fits.gz
     #set trace    b150910_2051.fits.gz
     #set standard b150910_2083.fits.gz
     ################################
    spect end

calcheck
========

Run this!
